<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Flow Graph</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
        }
        #mynetwork {
            width: 100%;
            height: 700px;
            border: 1px solid #444;
            background-color: #fff;
        }
        #timeline {
            width: 100%;
            height: 200px;
            border: 1px solid #444;
            margin-top: 20px;
            background-color: #fff;
        }
        .controls {
            padding: 20px;
            background: #ffffff;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 8px 8px;
        }
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        .control-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .control-group select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            color: #495057;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }
        .control-group input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            color: #495057;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            width: 100%;
            box-sizing: border-box;
        }
        .control-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
            min-width: 140px;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .export-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        .export-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        .legend-item span {
            font-size: 14px;
            color: #495057;
        }
        .select2-container--default .select2-selection--multiple {
            background-color: #444;
            border: 1px solid #666;
            color: #fff;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #666;
            border: 1px solid #888;
            color: #fff;
        }
        .cpu-profile-section {
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            overflow: hidden;
        }
        .cpu-profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.3s ease;
        }
        .cpu-profile-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .cpu-profile-title {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cpu-profile-icon {
            font-size: 18px;
        }
        .cpu-profile-toggle {
            font-size: 14px;
            transition: transform 0.3s ease;
        }
        .cpu-profile-content {
            display: none;
            padding: 20px;
            background: white;
            max-height: 400px;
            overflow-y: auto;
        }
        .cpu-profile-content.expanded {
            display: block;
        }
        .cpu-profile-pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            border: 1px solid #4a5568;
        }
        .cpu-profile-empty {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
        .cpu-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .cpu-metric-label {
            font-weight: 600;
            font-size: 14px;
            color: #495057;
            margin-bottom: 5px;
        }
        .cpu-metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        .cpu-metric-health {
            font-size: 14px;
            color: #495057;
            margin-top: 5px;
        }
        .health-good {
            color: #4ecdc4;
        }
        .health-warning {
            color: #ff6b6b;
        }
        .health-poor {
            color: #ff6b6b;
        }
        .cpu-profile-explanation {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .cpu-profile-legend {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .legend-term {
            font-weight: 600;
            color: #495057;
            margin-right: 5px;
        }
    </style>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Call Flow Graph</h1>
            <p>Interactive Call Flow Visualization</p>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value">18</div>
                <div class="stat-label">Functions</div>
            </div>
            <div class="stat">
                <div class="stat-value">16</div>
                <div class="stat-label">Call Relationships</div>
            </div>
            <div class="stat">
                <div class="stat-value">0.304s</div>
                <div class="stat-label">Total Duration</div>
            </div>
            
            
            
        </div>
        
        <div class="control-panel">
            <div class="control-group">
                <label for="layout">Layout:</label>
                <select id="layout" onchange="changeLayout(this.value)">
                    <option value="hierarchical">Hierarchical</option>
                    <option value="force">Force-Directed</option>
                    <option value="circular">Circular</option>
                    <option value="radial">Radial Tree</option>
                    <option value="grid">Grid</option>
                    <option value="tree">Tree (Vertical)</option>
                    <option value="tree-horizontal">Tree (Horizontal)</option>
                    <option value="timeline">Timeline</option>
                    <option value="organic">Organic (Spring)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="physics">Physics:</label>
                <select id="physics" onchange="togglePhysics(this.value === 'true')">
                    <option value="true">Enabled</option>
                    <option value="false">Disabled</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="filter">Filter by module:</label>
                <select id="filter">
                    <option value="">All modules</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="node-spacing">Node Spacing:</label>
                <select id="node-spacing" onchange="updateLayoutSpacing(this.value)">
                    <option value="100">Compact</option>
                    <option value="150" selected>Normal</option>
                    <option value="200">Relaxed</option>
                    <option value="300">Wide</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Export Options:</label>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToPng()" title="Download the current graph as a PNG image">
                        📊 Export as PNG
                    </button>
                    <button class="export-btn" onclick="exportToJson()" title="Download the graph data as a JSON file">
                        📄 Export as JSON
                    </button>
                </div>
            </div>
        </div>
        
        
        
        <div id="mynetwork"></div>
        <div id="timeline" style="display: none;"></div>
        
        <div class="controls">
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6b6b;"></div>
                    <span>Slow functions (>100ms avg)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4ecdc4;"></div>
                    <span>Medium functions (10-100ms avg)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #45b7d1;"></div>
                    <span>Fast functions (<10ms avg)</span>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // Graph data
        var nodes = [
  {
    "id": "<module>",
    "label": "<module>",
    "title": "Module: \nCalls: 0\nTotal Time: 0.000s\nAvg Time: 0.000s",
    "group": "main",
    "value": 0,
    "color": "#45b7d1",
    "module": "",
    "shape": "circle",
    "total_time": 0.0
  },
  {
    "id": "main",
    "label": "main",
    "title": "Module: \nCalls: 1\nTotal Time: 0.304s\nAvg Time: 0.304s",
    "group": "main",
    "value": 1,
    "color": "#ff6b6b",
    "module": "",
    "shape": "circle",
    "total_time": 0.304129
  },
  {
    "id": "callflow_tracer.tracer.wrapper",
    "label": "wrapper",
    "title": "Module: callflow_tracer.tracer\nCalls: 0\nTotal Time: 0.000s\nAvg Time: 0.000s",
    "group": "callflow_tracer.tracer",
    "value": 0,
    "color": "#45b7d1",
    "module": "callflow_tracer.tracer",
    "shape": "circle",
    "total_time": 0.0
  },
  {
    "id": "validate_input",
    "label": "validate_input",
    "title": "Module: \nCalls: 3\nTotal Time: 0.016s\nAvg Time: 0.005s",
    "group": "main",
    "value": 3,
    "color": "#45b7d1",
    "module": "",
    "shape": "circle",
    "total_time": 0.015721
  },
  {
    "id": "transform_data",
    "label": "transform_data",
    "title": "Module: \nCalls: 3\nTotal Time: 0.036s\nAvg Time: 0.012s",
    "group": "main",
    "value": 3,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.035649
  },
  {
    "id": "cache_lookup",
    "label": "cache_lookup",
    "title": "Module: \nCalls: 6\nTotal Time: 0.057s\nAvg Time: 0.009s",
    "group": "main",
    "value": 6,
    "color": "#45b7d1",
    "module": "",
    "shape": "circle",
    "total_time": 0.056542
  },
  {
    "id": "database_query",
    "label": "database_query",
    "title": "Module: \nCalls: 21\nTotal Time: 0.416s\nAvg Time: 0.020s",
    "group": "main",
    "value": 21,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.416499
  },
  {
    "id": "fetch_user_data",
    "label": "fetch_user_data",
    "title": "Module: \nCalls: 6\nTotal Time: 0.170s\nAvg Time: 0.028s",
    "group": "main",
    "value": 6,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.170276
  },
  {
    "id": "fetch_user_posts",
    "label": "fetch_user_posts",
    "title": "Module: \nCalls: 6\nTotal Time: 0.113s\nAvg Time: 0.019s",
    "group": "main",
    "value": 6,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.112575
  },
  {
    "id": "fetch_user_comments",
    "label": "fetch_user_comments",
    "title": "Module: \nCalls: 6\nTotal Time: 0.113s\nAvg Time: 0.019s",
    "group": "main",
    "value": 6,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.112688
  },
  {
    "id": "aggregate_user_activity",
    "label": "aggregate_user_activity",
    "title": "Module: \nCalls: 6\nTotal Time: 0.397s\nAvg Time: 0.066s",
    "group": "main",
    "value": 6,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.397219
  },
  {
    "id": "save_to_database",
    "label": "save_to_database",
    "title": "Module: \nCalls: 3\nTotal Time: 0.051s\nAvg Time: 0.017s",
    "group": "main",
    "value": 3,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.051249
  },
  {
    "id": "send_notification",
    "label": "send_notification",
    "title": "Module: \nCalls: 3\nTotal Time: 0.041s\nAvg Time: 0.014s",
    "group": "main",
    "value": 3,
    "color": "#4ecdc4",
    "module": "",
    "shape": "circle",
    "total_time": 0.040531
  },
  {
    "id": "process_user_request",
    "label": "process_user_request",
    "title": "Module: \nCalls: 3\nTotal Time: 0.325s\nAvg Time: 0.108s",
    "group": "main",
    "value": 3,
    "color": "#ff6b6b",
    "module": "",
    "shape": "circle",
    "total_time": 0.32535
  },
  {
    "id": "batch_process_requests",
    "label": "batch_process_requests",
    "title": "Module: \nCalls: 1\nTotal Time: 0.608s\nAvg Time: 0.608s",
    "group": "main",
    "value": 1,
    "color": "#ff6b6b",
    "module": "",
    "shape": "circle",
    "total_time": 0.608056
  },
  {
    "id": "<listcomp>",
    "label": "<listcomp>",
    "title": "Module: \nCalls: 1\nTotal Time: 0.000s\nAvg Time: 0.000s",
    "group": "main",
    "value": 1,
    "color": "#45b7d1",
    "module": "",
    "shape": "circle",
    "total_time": 1.1e-05
  },
  {
    "id": "process_analytics",
    "label": "process_analytics",
    "title": "Module: \nCalls: 1\nTotal Time: 0.108s\nAvg Time: 0.108s",
    "group": "main",
    "value": 1,
    "color": "#ff6b6b",
    "module": "",
    "shape": "circle",
    "total_time": 0.1085
  },
  {
    "id": "contextlib.__exit__",
    "label": "__exit__",
    "title": "Module: contextlib\nCalls: 1\nTotal Time: 0.000s\nAvg Time: 0.000s",
    "group": "contextlib",
    "value": 1,
    "color": "#45b7d1",
    "module": "contextlib",
    "shape": "circle",
    "total_time": 0.0
  }
];
        var edges = [
  {
    "from": "<module>",
    "to": "main",
    "label": "1 calls",
    "title": "Calls: 1\\nTotal Time: 0.304s\\nAvg Time: 0.304s",
    "width": 1,
    "color": "#ff6b6b"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "validate_input",
    "label": "3 calls",
    "title": "Calls: 3\\nTotal Time: 0.009s\\nAvg Time: 0.003s",
    "width": 1,
    "color": "#45b7d1"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "transform_data",
    "label": "3 calls",
    "title": "Calls: 3\\nTotal Time: 0.021s\\nAvg Time: 0.007s",
    "width": 1,
    "color": "#45b7d1"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "cache_lookup",
    "label": "6 calls",
    "title": "Calls: 6\\nTotal Time: 0.031s\\nAvg Time: 0.005s",
    "width": 1.2,
    "color": "#45b7d1"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "database_query",
    "label": "21 calls",
    "title": "Calls: 21\\nTotal Time: 0.214s\\nAvg Time: 0.010s",
    "width": 4.2,
    "color": "#4ecdc4"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "fetch_user_data",
    "label": "6 calls",
    "title": "Calls: 6\\nTotal Time: 0.093s\\nAvg Time: 0.015s",
    "width": 1.2,
    "color": "#4ecdc4"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "fetch_user_posts",
    "label": "6 calls",
    "title": "Calls: 6\\nTotal Time: 0.061s\\nAvg Time: 0.010s",
    "width": 1.2,
    "color": "#4ecdc4"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "fetch_user_comments",
    "label": "6 calls",
    "title": "Calls: 6\\nTotal Time: 0.061s\\nAvg Time: 0.010s",
    "width": 1.2,
    "color": "#4ecdc4"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "aggregate_user_activity",
    "label": "6 calls",
    "title": "Calls: 6\\nTotal Time: 0.217s\\nAvg Time: 0.036s",
    "width": 1.2,
    "color": "#4ecdc4"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "save_to_database",
    "label": "3 calls",
    "title": "Calls: 3\\nTotal Time: 0.031s\\nAvg Time: 0.010s",
    "width": 1,
    "color": "#4ecdc4"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "send_notification",
    "label": "3 calls",
    "title": "Calls: 3\\nTotal Time: 0.024s\\nAvg Time: 0.008s",
    "width": 1,
    "color": "#45b7d1"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "process_user_request",
    "label": "3 calls",
    "title": "Calls: 3\\nTotal Time: 0.195s\\nAvg Time: 0.065s",
    "width": 1,
    "color": "#4ecdc4"
  },
  {
    "from": "batch_process_requests",
    "to": "<listcomp>",
    "label": "1 calls",
    "title": "Calls: 1\\nTotal Time: 0.000s\\nAvg Time: 0.000s",
    "width": 1,
    "color": "#45b7d1"
  },
  {
    "from": "callflow_tracer.tracer.wrapper",
    "to": "process_analytics",
    "label": "1 calls",
    "title": "Calls: 1\\nTotal Time: 0.108s\\nAvg Time: 0.108s",
    "width": 1,
    "color": "#ff6b6b"
  },
  {
    "from": "<module>",
    "to": "batch_process_requests",
    "label": "1 calls",
    "title": "Calls: 1\\nTotal Time: 0.304s\\nAvg Time: 0.304s",
    "width": 1,
    "color": "#ff6b6b"
  },
  {
    "from": "<module>",
    "to": "contextlib.__exit__",
    "label": "1 calls",
    "title": "Calls: 1\\nTotal Time: 0.000s\\nAvg Time: 0.000s",
    "width": 1,
    "color": "#45b7d1"
  }
];

        // Wait for vis to be loaded
        function ensureVisLoaded(callback) {
            if (typeof vis !== "undefined" && vis.Network) {
                callback();
            } else {
                setTimeout(function() { ensureVisLoaded(callback); }, 100);
            }
        }

        ensureVisLoaded(function() {
            // Initialize network
            var container = document.getElementById('mynetwork');
            var data = {
                nodes: new vis.DataSet(nodes),
                edges: new vis.DataSet(edges)
            };

            // Store node and edge data for filtering
            window.allNodes = new vis.DataSet(nodes);
            window.allEdges = new vis.DataSet(edges);

            // Network options
            var options = {
                nodes: {
                    shape: 'box',
                    font: {
                        size: 12,
                        color: '#ffffff',
                        strokeWidth: 0,
                        strokeColor: '#000000'
                    },
                    borderWidth: 1,
                    shadow: true,
                    margin: 10,
                    widthConstraint: {
                        minimum: 100,
                        maximum: 200
                    }
                },
                edges: {
                    width: 1,
                    shadow: true,
                    smooth: {
                        type: 'continuous'
                    },
                    arrows: {
                        to: {enabled: true, scaleFactor: 0.8}
                    },
                    color: {
                        inherit: 'both',
                        opacity: 0.8
                    }
                },
                layout: {
                    hierarchical: {
                        enabled: false
                    }
                },
                physics: {
                    enabled: true,
                    solver: "forceAtlas2Based"
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };

            var network = new vis.Network(container, data, options);
            
            // Store network reference globally for export and control functions
            window.network = network;

            // Set initial layout and physics for footer controls
            document.getElementById('physics').value = "true";
            document.getElementById('layout').value = "force";

            // Layout change handler
            window.changeLayout = function(layoutType) {
                if (layoutType === "hierarchical") {
                    // Reset node positions for hierarchical layout
                    var resetNodes = nodes.map(function(node) {
                        return {
                            ...node,
                            x: undefined,
                            y: undefined,
                            fixed: {x: false, y: false}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(resetNodes);
                    
                    network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: true,
                                direction: 'UD',
                                sortMethod: 'directed'
                            }
                        },
                        physics: {enabled: false}
                    });
                    document.getElementById('layout').value = "hierarchical";
                    document.getElementById('physics').value = "false";
                } else if (layoutType === "force") {
                    // Reset node positions for force-directed layout
                    var resetNodes = nodes.map(function(node) {
                        return {
                            ...node,
                            x: undefined,
                            y: undefined,
                            fixed: {x: false, y: false}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(resetNodes);
                    
                    network.setOptions({
                        layout: {hierarchical: false},
                        physics: {enabled: true, solver: "forceAtlas2Based"}
                    });
                    document.getElementById('layout').value = "force";
                    document.getElementById('physics').value = "true";
                } else if (layoutType === "circular") {
                    // Create circular layout by updating node positions
                    var spacing = window.currentSpacing || 150;
                    var radius = spacing * 2; // Radius scales with spacing
                    var centerX = 400;
                    var centerY = 300;
                    var angleStep = 2 * Math.PI / nodes.length;
                    
                    var updatedNodes = nodes.map(function(node, i) {
                        var angle = i * angleStep;
                        return {
                            ...node,
                            x: centerX + radius * Math.cos(angle),
                            y: centerY + radius * Math.sin(angle),
                            fixed: {x: true, y: true}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(updatedNodes);
                    
                    network.setOptions({
                        layout: {hierarchical: false},
                        physics: {enabled: false}
                    });
                    document.getElementById('layout').value = "circular";
                    document.getElementById('physics').value = "false";
                    
                    // Fit the view after layout
                    setTimeout(() => network.fit(), 100);
                    
                } else if (layoutType === "timeline") {
                    // Create timeline layout sorted by execution time
                    var sorted = nodes.slice().sort(function(a, b) {
                        return a.total_time - b.total_time;
                    });
                    
                    var startX = 100;
                    var customSpacing = window.currentSpacing || 150;
                    var spacing = Math.max(customSpacing, (window.innerWidth - 200) / sorted.length);
                    var timelineY = 300;
                    
                    var updatedNodes = sorted.map(function(node, i) {
                        return {
                            ...node,
                            x: startX + i * spacing,
                            y: timelineY,
                            fixed: {x: true, y: true}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(updatedNodes);
                    
                    network.setOptions({
                        layout: {hierarchical: false},
                        physics: {enabled: false}
                    });
                    document.getElementById('layout').value = "timeline";
                    document.getElementById('physics').value = "false";
                    
                    // Fit the view after layout
                    setTimeout(() => network.fit(), 100);
                    
                } else if (layoutType === "radial") {
                    // Radial tree layout - nodes arranged in concentric circles by depth
                    var nodeMap = {};
                    nodes.forEach(n => nodeMap[n.id] = n);
                    
                    // Build adjacency list
                    var adjacency = {};
                    nodes.forEach(n => adjacency[n.id] = []);
                    edges.forEach(e => {
                        if (!adjacency[e.from]) adjacency[e.from] = [];
                        adjacency[e.from].push(e.to);
                    });
                    
                    // Find root nodes (nodes with no incoming edges)
                    var inDegree = {};
                    nodes.forEach(n => inDegree[n.id] = 0);
                    edges.forEach(e => inDegree[e.to] = (inDegree[e.to] || 0) + 1);
                    var roots = nodes.filter(n => inDegree[n.id] === 0).map(n => n.id);
                    if (roots.length === 0 && nodes.length > 0) roots = [nodes[0].id];
                    
                    // BFS to assign levels
                    var levels = {};
                    var queue = roots.map(r => [r, 0]);
                    var visited = new Set();
                    
                    while (queue.length > 0) {
                        var [nodeId, level] = queue.shift();
                        if (visited.has(nodeId)) continue;
                        visited.add(nodeId);
                        levels[nodeId] = level;
                        
                        (adjacency[nodeId] || []).forEach(child => {
                            if (!visited.has(child)) {
                                queue.push([child, level + 1]);
                            }
                        });
                    }
                    
                    // Assign unvisited nodes to level 0
                    nodes.forEach(n => {
                        if (!(n.id in levels)) levels[n.id] = 0;
                    });
                    
                    // Group nodes by level
                    var levelGroups = {};
                    Object.keys(levels).forEach(id => {
                        var level = levels[id];
                        if (!levelGroups[level]) levelGroups[level] = [];
                        levelGroups[level].push(id);
                    });
                    
                    // Calculate radial positions with custom spacing
                    var centerX = 400, centerY = 300;
                    var radiusStep = window.currentSpacing || 150;
                    var updatedNodes = [];
                    
                    Object.keys(levelGroups).forEach(level => {
                        var levelNodes = levelGroups[level];
                        var radius = level * radiusStep + 50;
                        var angleStep = (2 * Math.PI) / levelNodes.length;
                        
                        levelNodes.forEach((nodeId, i) => {
                            var angle = i * angleStep;
                            var node = nodeMap[nodeId];
                            updatedNodes.push({
                                ...node,
                                x: centerX + radius * Math.cos(angle),
                                y: centerY + radius * Math.sin(angle),
                                fixed: {x: true, y: true}
                            });
                        });
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(updatedNodes);
                    
                    network.setOptions({
                        layout: {hierarchical: false},
                        physics: {enabled: false}
                    });
                    document.getElementById('layout').value = "radial";
                    document.getElementById('physics').value = "false";
                    setTimeout(() => network.fit(), 100);
                    
                } else if (layoutType === "grid") {
                    // Grid layout - arrange nodes in a grid pattern
                    var cols = Math.ceil(Math.sqrt(nodes.length));
                    var spacing = window.currentSpacing || 200;
                    var startX = 100, startY = 100;
                    
                    var updatedNodes = nodes.map(function(node, i) {
                        var row = Math.floor(i / cols);
                        var col = i % cols;
                        return {
                            ...node,
                            x: startX + col * spacing,
                            y: startY + row * spacing,
                            fixed: {x: true, y: true}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(updatedNodes);
                    
                    network.setOptions({
                        layout: {hierarchical: false},
                        physics: {enabled: false}
                    });
                    document.getElementById('layout').value = "grid";
                    document.getElementById('physics').value = "false";
                    setTimeout(() => network.fit(), 100);
                    
                } else if (layoutType === "tree") {
                    // Vertical tree layout using hierarchical
                    var resetNodes = nodes.map(function(node) {
                        return {
                            ...node,
                            x: undefined,
                            y: undefined,
                            fixed: {x: false, y: false}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(resetNodes);
                    
                    var spacing = window.currentSpacing || 150;
                    network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: true,
                                direction: 'UD',
                                sortMethod: 'directed',
                                nodeSpacing: spacing,
                                levelSeparation: spacing * 1.3,
                                treeSpacing: spacing * 1.3
                            }
                        },
                        physics: {enabled: false}
                    });
                    document.getElementById('layout').value = "tree";
                    document.getElementById('physics').value = "false";
                    
                } else if (layoutType === "tree-horizontal") {
                    // Horizontal tree layout
                    var resetNodes = nodes.map(function(node) {
                        return {
                            ...node,
                            x: undefined,
                            y: undefined,
                            fixed: {x: false, y: false}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(resetNodes);
                    
                    var spacing = window.currentSpacing || 150;
                    network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: true,
                                direction: 'LR',
                                sortMethod: 'directed',
                                nodeSpacing: spacing,
                                levelSeparation: spacing * 1.7,
                                treeSpacing: spacing * 1.3
                            }
                        },
                        physics: {enabled: false}
                    });
                    document.getElementById('layout').value = "tree-horizontal";
                    document.getElementById('physics').value = "false";
                    
                } else if (layoutType === "organic") {
                    // Organic spring layout with custom physics
                    var resetNodes = nodes.map(function(node) {
                        return {
                            ...node,
                            x: undefined,
                            y: undefined,
                            fixed: {x: false, y: false}
                        };
                    });
                    
                    data.nodes.clear();
                    data.nodes.add(resetNodes);
                    
                    var spacing = window.currentSpacing || 150;
                    network.setOptions({
                        layout: {hierarchical: false},
                        physics: {
                            enabled: true,
                            solver: 'barnesHut',
                            barnesHut: {
                                gravitationalConstant: -8000,
                                centralGravity: 0.3,
                                springLength: spacing,
                                springConstant: 0.04,
                                damping: 0.09,
                                avoidOverlap: 0.5
                            },
                            stabilization: {
                                iterations: 200,
                                fit: true
                            }
                        }
                    });
                    document.getElementById('layout').value = "organic";
                    document.getElementById('physics').value = "true";
                }
            };

        // Set initial layout and physics for footer controls
        document.getElementById('physics').value = "true";
        document.getElementById('layout').value = "force";

        // Make changeLayout available globally
        window.changeLayout = changeLayout;
        
        // Store current layout spacing
        window.currentSpacing = 150;
        
        // Update layout spacing
        window.updateLayoutSpacing = function(spacing) {
            window.currentSpacing = parseInt(spacing);
            // Re-apply current layout with new spacing
            var currentLayout = document.getElementById('layout').value;
            changeLayout(currentLayout);
        };
        
        // Toggle physics
        window.togglePhysics = function(enabled) {
            if (window.network) {
                window.network.setOptions({ physics: { enabled: enabled } });
            }
        };

        // Export as PNG
        window.exportToPng = function() {
            try {
                // Wait for network to be ready
                if (!window.network) {
                    throw new Error('Network not initialized');
                }
                
                // Get the canvas from the network
                var canvas = window.network.canvas.frame.canvas;
                if (!canvas) {
                    throw new Error('Canvas not found. Please wait for the graph to load completely.');
                }
                
                // Create a temporary canvas with higher resolution
                var tempCanvas = document.createElement('canvas');
                var ctx = tempCanvas.getContext('2d');
                var scale = 2; // Higher resolution
                
                // Set the temporary canvas dimensions
                tempCanvas.width = canvas.width * scale;
                tempCanvas.height = canvas.height * scale;
                
                // Scale and draw the original canvas
                ctx.scale(scale, scale);
                ctx.drawImage(canvas, 0, 0);
                
                // Create download link
                var link = document.createElement('a');
                link.href = tempCanvas.toDataURL('image/png');
                link.download = 'callflow-graph-' + new Date().toISOString().slice(0, 10) + '.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up
                tempCanvas = null;
            } catch (error) {
                console.error('PNG export error:', error);
                alert('Error exporting PNG: ' + (error.message || 'Unknown error occurred'));
            }
        };

        // Export as JSON
        window.exportToJson = function() {
            try {
                // Use the original nodes and edges data instead of network.getData()
                if (!nodes || !edges) {
                    throw new Error('Graph data not available');
                }
                
                var exportData = {
                    metadata: {
                        total_nodes: nodes.length,
                        total_edges: edges.length,
                        duration: Number('0.304346'),
                        export_timestamp: new Date().toISOString(),
                        version: "callflow-tracer",
                        title: "Call Flow Graph"
                    },
                    nodes: nodes,
                    edges: edges
                };
                
                // Create a Blob with the JSON data
                var dataStr = JSON.stringify(exportData, null, 2);
                var dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // Create download link
                var link = document.createElement('a');
                var url = URL.createObjectURL(dataBlob);
                
                link.href = url;
                link.download = 'callflow-graph-' + new Date().toISOString().slice(0, 10) + '.json';
                
                // Add to document, trigger download, then clean up
                document.body.appendChild(link);
                link.click();
                
                // Show success message
                console.log('JSON export successful:', exportData.metadata);
                
                // Clean up
                setTimeout(function() {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
            } catch (error) {
                console.error('JSON export error:', error);
                console.error('Nodes available:', !!nodes, 'Edges available:', !!edges);
                console.error('Nodes length:', nodes ? nodes.length : 'undefined');
                console.error('Edges length:', edges ? edges.length : 'undefined');
                alert('Error exporting JSON: ' + (error.message || 'Unknown error occurred') + 
                      '\n\nPlease check the browser console for more details.');
            }
        };

        // --- Footer Controls ---

        // Physics toggle (footer)
        document.getElementById('physics').addEventListener('change', function() {
            var enabled = this.value === 'true';
            if (window.network) {
                window.network.setOptions({ physics: { enabled: enabled } });
            }
        });

            // Layout select (footer)
            document.getElementById('layout').addEventListener('change', function() {
                if (!window.network) return;
                if (this.value === 'hierarchical') {
                    window.network.setOptions({
                        layout: {
                            hierarchical: {
                                enabled: true,
                                direction: 'UD',
                                sortMethod: 'directed'
                            }
                        },
                        physics: { enabled: false }
                    });
                    document.getElementById('layout').value = "hierarchical";
                    document.getElementById('physics').value = "false";
                } else {
                    window.network.setOptions({
                        layout: { hierarchical: false },
                        physics: { enabled: true, solver: "forceAtlas2Based" }
                    });
                    document.getElementById('layout').value = "force";
                    document.getElementById('physics').value = "true";
                }
            });

            // Populate module filter dropdown
            const modulesSet = new Set();
            nodes.forEach(n => {
                if (n.module) {
                    modulesSet.add(n.module);
                } else {
                    modulesSet.add('__main__');  // Handle nodes without module
                }
            });
            
            const modulesArr = Array.from(modulesSet).sort();
            const filterSelect = document.getElementById('filter');
            
            // Remove all existing options except "All modules"
            while (filterSelect.options.length > 1) {
                filterSelect.remove(1);
            }
            
            // Add sorted module options
            modulesArr.forEach(module => {
                const option = document.createElement('option');
                option.value = module;
                option.textContent = module === '__main__' ? 'Main Module' : module;
                filterSelect.appendChild(option);
            });

            // Add module filter functionality
            filterSelect.addEventListener('change', function() {
                const selectedModule = this.value;
                
                if (selectedModule === '') {
                    // Show all nodes and edges
                    data.nodes.clear();
                    data.edges.clear();
                    data.nodes.add(window.allNodes.get());
                    data.edges.add(window.allEdges.get());
                    console.log('Filter: Showing all modules');
                } else {
                    // Filter nodes by selected module
                    const filteredNodes = window.allNodes.get().filter(node => {
                        if (selectedModule === '__main__') {
                            return !node.module || node.module === '' || node.module === '__main__';
                        }
                        return node.module === selectedModule;
                    });
                    
                    // Get IDs of filtered nodes
                    const filteredNodeIds = new Set(filteredNodes.map(node => node.id));
                    
                    // Filter edges that connect filtered nodes
                    const filteredEdges = window.allEdges.get().filter(edge => 
                        filteredNodeIds.has(edge.from) && filteredNodeIds.has(edge.to)
                    );
                    
                    // Update the network data
                    data.nodes.clear();
                    data.edges.clear();
                    data.nodes.add(filteredNodes);
                    data.edges.add(filteredEdges);
                    
                    console.log(`Filter: Showing module '${selectedModule}' - ${filteredNodes.length} nodes, ${filteredEdges.length} edges`);
                }
                
                // Fit the network to show all visible nodes
                setTimeout(() => {
                    if (window.network) {
                        window.network.fit({
                            animation: {
                                duration: 500,
                                easingFunction: 'easeInOutQuad'
                            }
                        });
                    }
                }, 100);
            });

            // Add some styling on load
            if (window.network) {
                window.network.on("stabilizationIterationsDone", function() {
                    // Keep physics enabled for force-directed by default
                    // window.network.setOptions({ physics: false });
                });

                // Set initial layout and physics to force-directed and enabled
                window.network.setOptions({
                    layout: {hierarchical: false},
                    physics: {enabled: true, solver: "forceAtlas2Based"}
                });
            }
            document.getElementById('layout-select').value = "force";
            document.getElementById('layout').value = "force";
            document.getElementById('physics').value = "true";

        });

        // CPU Profile Toggle Function
        function toggleCpuProfile() {
            const content = document.getElementById('cpu-content');
            const toggle = document.getElementById('cpu-toggle');
            
            if (content && toggle) {
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    toggle.textContent = '▼';
                    toggle.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('expanded');
                    toggle.textContent = '▲';
                    toggle.style.transform = 'rotate(180deg)';
                }
            }
        }
    </script>
</body>
</html>